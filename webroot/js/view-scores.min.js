function initAutocomplete(){$("#add-score-active .score-input.courseName").autocomplete({source:function(e,t){$.ajax({url:"/members-area/auto-complete",data:{searchTerm:e.term},dataType:"json",type:"get",success:function(e){if(e.length){var n=[];for(var r in e){var i=e[r].courseName;var s=e[r].slope;var o=e[r].rating;var u={label:i+" ::: Slope "+s+" ::: Rating "+o,value:i,slope:s,rating:o};n.push(u)}t(n)}}})},select:function(e,t){$("#add-score-active").find('input[name="slope"]').val(t.item.slope);$("#add-score-active").find('input[name="rating"]').val(t.item.rating)}})}function initTooltip(){$("#differential .tooltip").qtip({position:{my:"bottom center",at:"top center"},content:{title:"About Handicap Differential",text:$("#differential-tooltip-content-wrapper").html()}})}function adTrigger(){$.post("/members-area/ad-trigger",function(e){if(e.showAd){$("#adModal").dialog("open")}},"json")}function exportCsv(){window.location.href="/members-area/get-csv?orderBy="+sortField+"&dir="+sortDir}function deleteAllScores(){if(!scores.length){notify("No scores found to delete!","Delete All Scores Failed:");return}var e=confirm("Are you sure? This will permanently erase all of your saved scores!");if(e){$.post("/members-area/delete-all-scores",function(){fetchUserScores(true);refreshStats()})}}function addScore(){resetAll();var e=$($.parseHTML(addScoreRowActive));$(".add-score").replaceWith(e);e.find(".score-input.courseName").focus();initAutocomplete()}function sortTable(e){if(e.attr("id")==sortField){sortDir=sortDir=="DESC"?"ASC":"DESC"}sortField=e.attr("id");currentPage=1;fetchUserScores()}function fetchUserScores(e){$.get("/members-area/get-scores",{sortField:sortField,sortDir:sortDir},function(t){scores=t;totalPages=Math.ceil(scores.length/rowsPerPage)==0?1:Math.ceil(scores.length/rowsPerPage);renderScoresView();if(e){$("#fade-in-container").fadeIn("slow")}},"json")}function nav(e){if(currentPage>=totalPages&&e.attr("id")=="arrow-right"){return}if(e.attr("id")=="arrow-left"&&currentPage==1){return}if(e.attr("id")=="arrow-left"){currentPage--}else{currentPage++}renderScoresView()}function renderScoresView(){scoresTableContainer.html("");scoresTableContainer.append(scoresTable);scoresTableContainer.find("#scores-table").append(scoresTableHeadings);scoresTableContainer.find("#scores-table").append(addScoreRow);var e="";var t=currentPage*rowsPerPage;var n=t-rowsPerPage;var r=scores.slice(n,t);for(var i in r){e+=Mustache.render(scoreRow,r[i])}scoresTableContainer.find("#scores-table").append(e);refreshSortArrows();refreshNavArrows();initTooltip()}function refreshSortArrows(){scoresTableContainer.find(".sortable .sortArrows").each(function(){$(this).attr("src","/img/sort_neutral_green.png")});var e=sortDir=="DESC"?"/img/sort_down_green.png":"/img/sort_up_green.png";scoresTableContainer.find("#"+sortField+" .sortArrows").attr("src",e)}function refreshNavArrows(){$(".pagination-arrows").css("opacity","0.5");if(scores.length<=rowsPerPage){$(".pagination-arrows").css("opacity","0.5")}else{if(currentPage==1){$("#arrow-right").css("opacity","1")}else if(currentPage>1&&currentPage*rowsPerPage>=scores.length){$("#arrow-left").css("opacity","1")}else{$(".pagination-arrows").css("opacity","1")}}if(scores.length<=(currentPage-1)*rowsPerPage){nav($("#arrow-left"))}$("#pagination").text("Page "+currentPage+"/"+totalPages)}function deleteScore(e){var t=e.parents("tr").index()-2;t=rowsPerPage*(currentPage-1)+t;var n="Are you sure you want to delete this score?\r\n("+scores[t].score+" at "+scores[t].courseName+" on "+scores[t].formattedDate+")";var r=confirm(n);if(r){var i=e.parents("tr").find('input[name="id"]').val();$.post("/members-area/delete-score",{id:i},function(){fetchUserScores();refreshStats()})}}function editScore(e){resetAll();var t=e.parents("tr");var n=t.index()-2;n=rowsPerPage*(currentPage-1)+n;t.replaceWith(Mustache.render(editScoreRow,scores[n]))}function resetAll(){if($("#add-score-active").length){cancelSave($("#add-score-active").find(".cancelSave"))}$(".edit-score").each(function(){cancelSave($(this).find(".cancelSave"))})}function cancelSave(e){if(e.parents("#add-score-active").length){$("#add-score-active").replaceWith(addScoreRow)}else{var t=e.parents("tr");var n=t.index()-2;n=rowsPerPage*(currentPage-1)+n;t.replaceWith(Mustache.render(scoreRow,scores[n]))}}function saveScore(e){var t=e.parents("tr");if(!validateScoreData(t)){return}var n=t.find(".score-input").serialize();$.post("/members-area/save-score",n,function(e){if(e.length){errString="";for(var t in e){errString+=e[t]+"\r\n"}alert(errString);return}fetchUserScores();refreshStats();notify("Your score has been saved.","Score Saved")},"json")}function validateScoreData(e){e.find(".score-input").each(function(){$(this).css("border","2px ridge #CCC")});var t=function(e){e.css("border","2px solid red")};var n=e.find('input[name="courseName"]');var r=e.find('input[name="formattedDate"]');var i=e.find('input[name="score"]');var s=e.find('input[name="slope"]');var o=e.find('input[name="rating"]');var u=e.find('input[name="holesPlayed"]');var a=[];if(!n.val()){a.push("Please enter a valid course name.");t(n)}if(!r.val()){a.push("Please enter a valid date.");t(r)}if(!i.val()){a.push("Please enter a valid score.");t(i)}if(!s.val()){a.push("Please enter a valid slope.");t(s)}if(!o.val()){a.push("Please enter a valid rating.");t(o)}if(!u.val()){a.push("Please enter the number of holes played.");t(u)}if(u.val()>18||u.val()<13){a.push("Rounds must be between 13 and 18 holes to be eligible for handicap.");t(u)}if(a.length){errString='<ul class="score-errors">';for(var f in a){errString+="<li>"+a[f]+"</li>"}errString+="</ul>";notify(errString,"Error Saving Score:");return false}return true}var sortField="date";var sortDir="DESC";var rowsPerPage=10;var currentPage=1;var totalPages;var scores;var scoresTableContainer;var scoresTable;var scoresTableHeadings;var addScoreRow;var addScoreRowActive;var scoreRow;var editScoreRow;$(document).ready(function(){scoresTableContainer=$("#scores-table-container");scoresTable=$("#scores-table-template").html();scoresTableHeadings=$("#scores-table-headings-template").html();addScoreRow=$("#add-score-template").html();addScoreRowActive=$("#add-score-active-template").html();scoreRow=$("#score-template").html();editScoreRow=$("#edit-score-template").html();$("body").on("click",".sortable",function(){sortTable($(this))});$("body").on("click",".row-icon.delete",function(){deleteScore($(this))});$("body").on("click",".row-icon.edit",function(){editScore($(this))});$("body").on("click",".row-icon.cancelSave",function(){cancelSave($(this))});$("body").on("click",".row-icon.save",function(){saveScore($(this))});$("body").on("click",".add-score",function(){addScore()});$("#delete-all").click(function(){deleteAllScores()});$(".pagination-arrows").click(function(){nav($(this))});$("#export-csv").click(function(){exportCsv()});$("body").on("focus",".formattedDate",function(){$(this).datepicker()});fetchUserScores(true);$("#adModal").dialog({title:"The New FreeHandicapTracker.net",modal:true,width:570,autoOpen:false});refreshStats()});