function sortTable(e){scoresTableHeadings.find(".sortable img").each(function(){$(this).attr("src","/img/sort_neutral_green.png")});if(e.attr("id")==sortField){sortDir=sortDir=="DESC"?"ASC":"DESC"}sortField=e.attr("id");var t=sortDir=="DESC"?"/img/sort_down_green.png":"/img/sort_up_green.png";scoresTableHeadings.find("#"+sortField+" img").attr("src",t);fetchUserScores()}function fetchUserScores(){$.get("/members-area/get-scores",{sortField:sortField,sortDir:sortDir},function(e){scores=e;renderScoresView()},"json")}function renderScoresView(){if(!scores.length){$("#scores-table-container").html(noScores.html());return}buildScoresTable();$("#scores-table-container").html(scoresTable.clone().wrap("<div />").parent().html())}function buildScoresTable(){scoresTable.html("");scoresTable.append(scoresTableHeadings.html());scoresTable.append(addNewScoreRow.html());var e="";for(var t in scores){e+=Mustache.render(scoreRowTemplate,scores[t])}scoresTable.append(e)}function deleteScore(e){var t=e.parents("tr").index();var n="Are you sure you want to delete this score?\r\n("+scores[t].score+" at "+scores[t].courseName+" on "+scores[t].formattedDate+")";var r=confirm(n);if(r){var i=e.parents("tr").find(".scoreId").val();$.post("/members-area/delete-score",{id:i},function(){fetchUserScores();refreshHandicap()})}}function editScore(e){$("#scores-table tr").each(function(){if($(this).find(".row-icon.cancelEdit").length){cancelEdit($(this).find(".row-icon.cancelEdit"));return}});var t=e.parents("tr");var n=t.index();e.attr("src","/img/save.png").removeClass("edit").addClass("save").attr("title","Save");var r=t.find(".row-icon.delete");r.attr("src","/img/cancel_save.png").removeClass("delete").addClass("cancelEdit").attr("title","Cancel");t.find(".editable").each(function(){var e=$(this).attr("class").split(" ")[1];var t=scores[n][e];var r='<input class="edit-score-input '+e+'" type="text" value="'+t+'" />';$(this).html(r)});t.find(".editable.score").append('<input class="scoreId" type="hidden" value="'+scores[n].id+'">')}function cancelEdit(e){var t=e.parents("tr");var n=t.index();t.replaceWith(Mustache.render(scoreRowTemplate,scores[n]))}function saveScore(e){var t=e.parents("tr");if(!validateScoreData(t)){return}var n={};t.find(".editable").each(function(){var e=$(this).attr("class").split(" ")[1];var t=$(this).find(".edit-score-input."+e).val();n[e]=t});n.id=t.find(".scoreId").val();n.date=n.formattedDate;$.post("/members-area/save-score",n,function(e){if(e.length){errString="";for(var t in e){errString+=e[t]+"\r\n"}alert(errString);return}fetchUserScores();refreshHandicap();notify("Score Saved.",2e3)},"json")}function validateScoreData(e){e.find(".edit-score-input").each(function(){$(this).css("border","2px solid transparent")});var t=function(e){e.css("border","2px solid red")};var n=e.find("td .courseName");var r=e.find("td .formattedDate");var i=e.find("td .score");var s=e.find("td .slope");var o=e.find("td .rating");var u=e.find("td .holesPlayed");var a=[];if(!n.val()){a.push("Please enter a valid course name.");t(n)}if(!r.val()){a.push("Please enter a valid date.");t(r)}if(!i.val()){a.push("Please enter a valid score.");t(i)}if(!s.val()){a.push("Please enter a valid slope.");t(s)}if(!o.val()){a.push("Please enter a valid rating.");t(o)}if(!u.val()){a.push("Please enter the number of holes played.");t(u)}if(u.val()>18||u.val()<13){a.push("Rounds must be between 13 and 18 holes to be eligible for handicap.");t(u)}if(a.length){errString="";for(var f in a){errString+=a[f]+"<br />"}notify(errString,5e3,true);return false}return true}function refreshHandicap(){$.get("/members-area/get-handicap",function(e){$("#hcp").text(e)})}var sortField="date";var sortDir="DESC";var scores;var scoresTable;var noScores;var scoresTableHeadings;var addNewScoreRow;var scoreRowTemplate;$(document).ready(function(){scoresTable=$("#scores-table-template").children();noScores=$("#no-scores-template").children();scoresTableHeadings=$("#scores-table-headings-template").children();addNewScoreRow=$("#add-new-score-template").children();scoreRowTemplate=$("#score-rows-template").html();fetchUserScores();$("body").on("click",".sortable",function(){sortTable($(this))});$("body").on("click",".row-icon.delete",function(){deleteScore($(this))});$("body").on("click",".row-icon.edit",function(){editScore($(this))});$("body").on("click",".row-icon.cancelEdit",function(){cancelEdit($(this))});$("body").on("click",".row-icon.save",function(){saveScore($(this))})})